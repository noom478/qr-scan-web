<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>สแกน QR | Multi-Location Realtime | ส่งออก Excel ตามวันที่</title>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>body{margin:0;font-family:system-ui;background:#0b1220;color:#e5e7eb}header{padding:12px 16px;border-bottom:1px solid #1f2937;background:#111827bd}main{padding:16px;max-width:1100px;margin:0 auto}.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}input,button,select{padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1020;color:#e5e7eb}button{cursor:pointer;font-weight:600}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}#reader{width:300px;height:300px;border:1px dashed #1f2937;border-radius:12px;background:#0b1020}</style>
</head>
<body>
  <header>
    <b>สแกน QR | หลายสาขา (Realtime) | ส่งออก Excel ตามวันที่</b> 
    <span id="status" style="margin-left:8px;opacity:.85"></span>
  </header>

  <main>
    <section>
      <div class="row" style="grid-template-columns:1fr auto auto;align-items:center">
        <div>
          <label>เลือกกล้อง</label>
          <select id="cameraSelect"></select>
        </div>
        <button id="btnStart">เริ่มสแกน</button>
        <button id="btnStop" disabled>หยุด</button>
      </div>
      <div id="reader" style="margin-top:10px"></div>
      <div style="margin-top:10px">
        <label>ข้อมูลที่สแกน</label>
        <input id="scanValue" type="text" readonly style="width:100%"/>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="site" placeholder="สาขา/สถานที่"/>
        <input id="slot" placeholder="ตำแหน่งจอด"/>
        <input id="remark" placeholder="หมายเหตุ"/>
      </div>
      <div style="margin-top:10px">
        <button id="btnSave" disabled>บันทึก (ขึ้นคลาวด์)</button>
        <span id="saveMsg" style="margin-left:8px"></span>
      </div>
    </section>

    <hr style="margin:16px 0;border:0;border-top:1px solid #1f2937" />

    <section>
      <div class="row">
        <div><label>วันที่เริ่ม</label><input id="dateStart" type="date"/></div>
        <div><label>ถึงวันที่</label><input id="dateEnd" type="date"/></div>
        <div><label>สาขา (กรอง)</label><input id="filterSite" placeholder="ว่าง = ทุกสาขา"/></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="btnListen">เริ่มดู Realtime</button>
        <button id="btnExport">ส่งออก Excel</button>
        <span id="listenMode" style="margin-left:auto">โหมด: ปิด</span>
        <span id="countPill">0 รายการ</span>
      </div>

      <table id="table">
        <thead><tr><th>เวลา</th><th>ข้อมูล</th><th>สาขา</th><th>ตำแหน่ง</th><th>หมายเหตุ</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ===== firebaseConfig ของผู้ใช้ (แทนที่เรียบร้อย) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBeaMdl5LMZ6dc2y17YrI6rOVfGcClua20",
      authDomain: "scanqr-e0077.firebaseapp.com",
      projectId: "scanqr-e0077",
      storageBucket: "scanqr-e0077.firebasestorage.app",
      messagingSenderId: "1005016680423",
      appId: "1:1005016680423:web:6b4a8507ec958337b05f42",
      measurementId: "G-7S1F4HNJ9T"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(console.error);

    // ===== Helpers/State =====
    let html5QrCode=null, currentCameraId=null, unsubscribe=null, currentRows=[];
    const $ = (id)=>document.getElementById(id);
    const pad=(n)=>String(n).padStart(2,'0');
    const fmt=(d=new Date())=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}
    const statusEl = $('status');

    // ===== Scanner =====
    async function listCameras(){
      const sel=$('cameraSelect'); sel.innerHTML='<option>ค้นหากล้อง...</option>';
      try{
        const dev=await Html5Qrcode.getCameras(); sel.innerHTML='';
        if(!dev.length){ sel.innerHTML='<option>ไม่พบกล้อง</option>'; return; }
        dev.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.label||`กล้อง ${i+1}`; sel.appendChild(o); });
        currentCameraId=dev[0].id; sel.value=currentCameraId;
      }catch(e){ sel.innerHTML='<option>อนุญาตกล้องก่อน</option>'; }
    }
    async function startScan(){
      const el=$('reader'); $('btnStart').disabled=true; $('btnStop').disabled=false;
      if(!html5QrCode){ html5QrCode=new Html5Qrcode('reader'); } else { try{ await html5QrCode.stop(); }catch(e){} el.innerHTML=''; }
      try{ await html5QrCode.start({deviceId:{exact:currentCameraId}}, {fps:10, qrbox:{width:250,height:250}}, onScan, ()=>{}); }catch(e){ $('btnStart').disabled=false; $('btnStop').disabled=true; }
    }
    async function stopScan(){ if(html5QrCode){ try{ await html5QrCode.stop(); }catch(e){} } $('btnStart').disabled=false; $('btnStop').disabled=true; }
    function onScan(text){ $('scanValue').value=text; $('btnSave').disabled=false; if(navigator.vibrate) navigator.vibrate(80); }

    // ===== Save =====
    $('btnSave').addEventListener('click', async ()=>{
      const value=$('scanValue').value.trim(), site=$('site').value.trim(), slot=$('slot').value.trim(), remark=$('remark').value.trim();
      if(!value){ $('saveMsg').textContent='ยังไม่มีข้อมูลจากการสแกน'; return; }
      try{
        const now=new Date();
        await db.collection('qr_records').add({ createdAt: firebase.firestore.Timestamp.fromDate(now), timeText: fmt(now), value, site, slot, remark, clientId:(auth.currentUser&&auth.currentUser.uid)||null });
        $('saveMsg').textContent='บันทึกแล้ว (คลาวด์)'; $('scanValue').value=''; $('slot').value=''; $('remark').value=''; $('btnSave').disabled=true;
      }catch(e){ $('saveMsg').textContent='บันทึกล้มเหลว'; }
    });

    // ===== Listen + Render =====
    function range(d1,d2){ const s=d1?new Date(d1+'T00:00:00'):new Date(new Date().toDateString()); const e=d2?new Date(d2+'T23:59:59'):new Date(new Date().toDateString()+' 23:59:59'); return [s,new Date(e.getTime())]; }
    function qBuild(){ const [s,e]=range($('dateStart').value,$('dateEnd').value); let q=db.collection('qr_records').where('createdAt','>=',firebase.firestore.Timestamp.fromDate(s)).where('createdAt','<=',firebase.firestore.Timestamp.fromDate(e)).orderBy('createdAt','desc'); const f=$('filterSite').value.trim(); if(f){ q=q.where('site','==',f); } return q; }
    function render(rows){ const tb=$('tbody'); tb.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(r.timeText)}</td><td>${esc(r.value)}</td><td>${esc(r.site||'')}</td><td>${esc(r.slot||'')}</td><td>${esc(r.remark||'')}</td>`; tb.appendChild(tr); }); $('countPill').textContent=rows.length+' รายการ'; }
    $('btnListen').addEventListener('click',()=>{ if(unsubscribe){unsubscribe();unsubscribe=null;} const q=qBuild(); unsubscribe=q.onSnapshot(s=>{ currentRows=s.docs.map(d=>d.data()); render(currentRows); $('listenMode').textContent='โหมด: เปิด (Realtime)'; }); });
    $('btnExport').addEventListener('click',()=>{ if(typeof XLSX==='undefined'){ alert('ยังโหลดไลบรารีส่งออกไม่เสร็จ'); return; } const rows=[['เวลา','ข้อมูล','สาขา','ตำแหน่ง','หมายเหตุ']]; currentRows.forEach(r=>rows.push([r.timeText||'',r.value||'',r.site||'',r.slot||'',r.remark||''])); const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'QR Records'); const ds=$('dateStart').value||'from',de=$('dateEnd').value||'to',site=($('filterSite').value.trim()||'all').replace(/\s+/g,'_'); XLSX.writeFile(wb,`qr_records_${ds}_${de}_${site}.xlsx`); });

    // ===== Init =====
    window.addEventListener('load', async ()=>{
      const t=new Date(), y=t.getFullYear(), m=pad(t.getMonth()+1), d=pad(t.getDate());
      $('dateStart').value=`${y}-${m}-${d}`;
      $('dateEnd').value=`${y}-${m}-${d}`;
      await listCameras();
      statusEl.textContent='พร้อมเชื่อมต่อ Firebase';
      if (location.protocol==='http:' && location.hostname!=='localhost') {
        statusEl.textContent+=' (ควรใช้ HTTPS เพื่อเปิดกล้อง)';
      }
    });
    $('cameraSelect').addEventListener('change', e=>{ currentCameraId=e.target.value; if(!$('btnStart').disabled) return; startScan(); });
    $('btnStart').addEventListener('click', startScan);
    $('btnStop').addEventListener('click', stopScan);
  </script>
</body>
</html>
